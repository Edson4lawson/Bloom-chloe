# =============================================================================
# BLOOM-CHLOE - CONFIGURATION NGINX SÉCURISÉE
# =============================================================================
# Cette configuration implémente toutes les bonnes pratiques de sécurité
# Testée pour un score A+ sur SSL Labs et Security Headers
# =============================================================================

# Limites de connexion (protection DDoS)
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;
limit_req_zone $binary_remote_addr zone=req_limit:20m rate=20r/s;
limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=1r/s;
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=50r/s;

# Cache pour les sessions SSL
ssl_session_cache shared:SSL:10m;
ssl_session_timeout 1d;
ssl_session_tickets off;

# =============================================================================
# SERVEUR HTTPS PRINCIPAL
# =============================================================================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name bloom-chloe.com www.bloom-chloe.com;
    
    # Document root pour le frontend Vue.js
    root /var/www/bloom-chloe/dist;
    index index.html;
    
    # =========================================================================
    # CONFIGURATION SSL/TLS
    # =========================================================================
    ssl_certificate /etc/letsencrypt/live/bloom-chloe.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/bloom-chloe.com/privkey.pem;
    
    # Protocoles TLS (désactiver TLS 1.0 et 1.1)
    ssl_protocols TLSv1.2 TLSv1.3;
    
    # Suites de chiffrement sécurisées
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    
    # OCSP Stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/letsencrypt/live/bloom-chloe.com/chain.pem;
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;
    
    # Diffie-Hellman parameters
    # Générer avec: openssl dhparam -out /etc/nginx/ssl/dhparam.pem 4096
    # ssl_dhparam /etc/nginx/ssl/dhparam.pem;
    
    # =========================================================================
    # HEADERS DE SÉCURITÉ
    # =========================================================================
    
    # HSTS (forcer HTTPS pendant 1 an)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    
    # Protection contre le clickjacking
    add_header X-Frame-Options "DENY" always;
    
    # Protection contre le MIME sniffing
    add_header X-Content-Type-Options "nosniff" always;
    
    # Protection XSS
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Politique de référent
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Politique de permissions
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()" always;
    
    # Content Security Policy
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https: blob:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://api.bloom-chloe.com; frame-ancestors 'none'; base-uri 'self'; form-action 'self';" always;
    
    # =========================================================================
    # LIMITES ET PROTECTION DDOS
    # =========================================================================
    
    # Limite de connexions par IP
    limit_conn conn_limit 30;
    
    # Limite de requêtes globale
    limit_req zone=req_limit burst=30 nodelay;
    
    # Taille maximale des requêtes
    client_max_body_size 10M;
    client_body_timeout 30s;
    client_header_timeout 30s;
    
    # Bloquer les user-agents suspects
    if ($http_user_agent ~* (bot|crawl|spider|scraper|scanner|nikto|sqlmap|nmap)) {
        return 403;
    }
    
    # Bloquer les méthodes HTTP non utilisées
    if ($request_method !~ ^(GET|POST|PUT|DELETE|PATCH|OPTIONS|HEAD)$) {
        return 405;
    }
    
    # =========================================================================
    # LOCATIONS
    # =========================================================================
    
    # Frontend Vue.js (SPA)
    location / {
        try_files $uri $uri/ /index.html;
        
        # Cache pour les fichiers HTML
        location ~* \.html$ {
            expires -1;
            add_header Cache-Control "no-store, no-cache, must-revalidate";
        }
    }
    
    # Assets statiques (JS, CSS, images)
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # API PHP Backend
    location /api/ {
        # Rate limiting pour l'API
        limit_req zone=api_limit burst=20 nodelay;
        
        # Proxy vers PHP-FPM ou serveur PHP
        # Option 1: PHP-FPM
        # fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        # fastcgi_index index.php;
        # include fastcgi_params;
        # fastcgi_param SCRIPT_FILENAME /var/www/bloom-chloe/api$fastcgi_script_name;
        
        # Option 2: Proxy vers serveur PHP intégré
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # Endpoints d'authentification (rate limiting strict)
    location ~ ^/api/auth/(login|register)\.php$ {
        limit_req zone=auth_limit burst=3 nodelay;
        
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Bloquer l'accès aux fichiers sensibles
    location ~ /\. {
        deny all;
    }
    
    location ~ \.(env|sql|log|bak|backup|old|conf)$ {
        deny all;
    }
    
    # Bloquer l'accès au dossier config de l'API
    location ~ ^/api/config/ {
        deny all;
    }
    
    # Bloquer l'accès aux migrations
    location ~ ^/api/migrations/ {
        deny all;
    }
    
    # =========================================================================
    # LOGGING
    # =========================================================================
    
    access_log /var/log/nginx/bloom-chloe.access.log combined buffer=512k flush=1m;
    error_log /var/log/nginx/bloom-chloe.error.log warn;
}

# =============================================================================
# REDIRECTION HTTP VERS HTTPS
# =============================================================================
server {
    listen 80;
    listen [::]:80;
    server_name bloom-chloe.com www.bloom-chloe.com;
    
    # Redirection permanente vers HTTPS
    return 301 https://$host$request_uri;
}

# =============================================================================
# REDIRECTION WWW VERS NON-WWW (optionnel)
# =============================================================================
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name www.bloom-chloe.com;
#     
#     ssl_certificate /etc/letsencrypt/live/bloom-chloe.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/bloom-chloe.com/privkey.pem;
#     
#     return 301 https://bloom-chloe.com$request_uri;
# }
